<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Farmatodo ERP</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Farmatodo ERP</div>
    <div class="user-area">
      <span id="userInfo"></span>
      <button id="logoutBtn">Cerrar sesión</button>
    </div>
  </header>

  <main class="container">
    <h2>Administración de Usuarios y Roles</h2>
    <p id="mensaje" class="muted">Lista de usuarios (admin puede editar y eliminar). Selecciona un usuario para editar.</p>

    <section class="table-wrap">
      <table id="usersTable">
        <thead>
          <tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="edit-panel">
      <h3>Editar usuario</h3>
      <form id="editForm">
        <input type="hidden" id="edit_id" />
        <label>Nombre</label>
        <input id="edit_nombre" />
        <label>Email</label>
        <input id="edit_email" type="email" />
        <label>Rol</label>
        <select id="edit_tipo_usuario"></select>
        <label>Activo</label>
        <select id="edit_activo">
          <option value="1">Activo</option>
          <option value="0">Inactivo</option>
        </select>
        <label>Contraseña (si quieres cambiarla)</label>
        <input id="edit_password" type="password" />

        <div style="margin-top:10px;">
          <button id="saveBtn" type="submit">Guardar cambios</button>
          <button id="cancelBtn" type="button">Cancelar</button>
        </div>
        <div id="resultMsg" style="margin-top:8px;"></div>
      </form>
    </section>

    <div id="output"></div>
  </main>

  <script src="/js/auth.js"></script>
  <script>
    (async function () {
      const auth = window.APP_AUTH;
      if (!auth.isAuthenticated()) { location.replace('/login.html'); return; }
      const user = auth.getUser();
      document.getElementById('userInfo').textContent = user ? `${user.nombre} (${(user.roles||[]).join(', ')})` : '';

      // elementos
      const tbody = document.querySelector('#usersTable tbody');
      const rolesSelect = document.getElementById('edit_tipo_usuario');
      const form = document.getElementById('editForm');
      const resultMsg = document.getElementById('resultMsg');

      async function loadRoles() {
        try {
          const res = await auth.fetchAuth('/api/roles');
          const json = await res.json();
          const roles = json.roles || [];
          rolesSelect.innerHTML = roles.map(r => `<option value="${r.id_rol}">${r.nombre_rol}</option>`).join('');
        } catch (err) {
          console.error('Error cargando roles', err);
        }
      }

      async function loadUsers() {
        try {
          const res = await auth.fetchAuth('/api/users');
          const json = await res.json();
          const users = json.users || [];
          tbody.innerHTML = users.map(u => `
            <tr>
              <td>${u.id_usuario}</td>
              <td>${u.nombre}</td>
              <td>${u.email}</td>
              <td>${u.tipo_usuario ?? ''}</td>
              <td>${u.activo ? 'Activo' : 'Inactivo'}</td>
              <td>
                <button data-id="${u.id_usuario}" class="btn-edit">Editar</button>
                <button data-id="${u.id_usuario}" class="btn-delete">Eliminar</button>
              </td>
            </tr>
          `).join('');

          // attach events
          document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEditClick));
          document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDeleteClick));

        } catch (err) {
          console.error('Error cargando usuarios', err);
        }
      }

      function clearForm() {
        form.reset();
        document.getElementById('edit_id').value = '';
        resultMsg.textContent = '';
      }

      async function onEditClick(e) {
        const id = e.currentTarget.dataset.id;
        // poblar formulario con datos del usuario seleccionado (simple: buscamos en la tabla ya cargada)
        const row = e.currentTarget.closest('tr');
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nombre').value = row.children[1].textContent;
        document.getElementById('edit_email').value = row.children[2].textContent;
        // tipo_usuario: en la tabla solo vemos id; set value
        document.getElementById('edit_tipo_usuario').value = row.children[3].textContent || '';
        document.getElementById('edit_activo').value = row.children[4].textContent === 'Activo' ? '1' : '0';
        document.getElementById('edit_password').value = '';
        window.scrollTo({ top: document.querySelector('.edit-panel').offsetTop, behavior: 'smooth' });
      }

      async function onDeleteClick(e) {
        if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;
        const id = e.currentTarget.dataset.id;
        try {
          const res = await auth.fetchAuth(`/api/users/${id}`, { method: 'DELETE' });
          const body = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
          resultMsg.textContent = 'Usuario eliminado correctamente';
          await loadUsers();
        } catch (err) {
          resultMsg.textContent = `Error: ${err.message}`;
        }
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const id = document.getElementById('edit_id').value;
        if (!id) { resultMsg.textContent = 'Seleccione un usuario a editar'; return; }
        const payload = {
          nombre: document.getElementById('edit_nombre').value,
          email: document.getElementById('edit_email').value,
          tipo_usuario: Number(document.getElementById('edit_tipo_usuario').value) || null,
          activo: document.getElementById('edit_activo').value === '1' ? 1 : 0
        };
        const password = document.getElementById('edit_password').value;
        if (password) payload.password = password;

        try {
          const res = await auth.fetchAuth(`/api/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const body = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
          resultMsg.textContent = 'Usuario actualizado correctamente';
          await loadUsers();
          // limpiar password
          document.getElementById('edit_password').value = '';
        } catch (err) {
          resultMsg.textContent = `Error: ${err.message}`;
        }
      });

      document.getElementById('cancelBtn').addEventListener('click', () => clearForm());
      document.getElementById('logoutBtn').addEventListener('click', () => { auth.logout(); location.replace('/login.html'); });

      // carga inicial
      await loadRoles();
      await loadUsers();
    })();
  </script>
</body>
</html>
