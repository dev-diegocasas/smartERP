<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard - Farmatodo ERP</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <header class="topbar">
    <div class="brand">Farmatodo ERP</div>
    <div class="user-area">
      <span id="userInfo"></span>
      <button id="logoutBtn">Cerrar sesión</button>
    </div>
  </header>

  <main class="container">
    <h2>Administración de Usuarios, Roles y Permisos</h2>
    <p id="mensaje" class="muted">Gestiona usuarios, roles y permisos del sistema.</p>

    <!-- Tabs para navegar entre secciones -->
    <div class="tabs">
      <button class="tab-button active" data-tab="usuarios">Usuarios</button>
      <button class="tab-button" data-tab="permisos">Permisos</button>
      <button class="tab-button" data-tab="roles-permisos">Asignación de Permisos</button>
    </div>

    <!-- Sección de Usuarios -->
    <div id="usuarios-tab" class="tab-content active">
      <section class="table-wrap">
        <h3>Lista de Usuarios</h3>
        <table id="usersTable">
          <thead>
            <tr><th>ID</th><th>Nombre</th><th>Email</th><th>Rol</th><th>Estado</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <section class="edit-panel">
        <h3>Editar usuario</h3>
        <form id="editForm">
          <input type="hidden" id="edit_id" />
          <label>Nombre</label>
          <input id="edit_nombre" />
          <label>Email</label>
          <input id="edit_email" type="email" />
          <label>Rol</label>
          <select id="edit_tipo_usuario"></select>
          <label>Activo</label>
          <select id="edit_activo">
            <option value="1">Activo</option>
            <option value="0">Inactivo</option>
          </select>
          <label>Contraseña (si quieres cambiarla)</label>
          <input id="edit_password" type="password" />

          <div style="margin-top:10px;">
            <button id="saveBtn" type="submit">Guardar cambios</button>
            <button id="cancelBtn" type="button">Cancelar</button>
          </div>
          <div id="resultMsg" style="margin-top:8px;"></div>
        </form>
      </section>
    </div>

    <!-- Sección de Permisos -->
    <div id="permisos-tab" class="tab-content">
      <section class="table-wrap">
        <h3>Lista de Permisos</h3>
        <div style="margin-bottom: 10px;">
          <button id="addPermisoBtn" class="btn-primary">Agregar Permiso</button>
        </div>
        <table id="permisosTable">
          <thead>
            <tr><th>ID</th><th>Nombre</th><th>Descripción</th><th>Acciones</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </section>

      <!-- Formulario para agregar/editar permisos -->
      <section class="edit-panel" id="permisoForm" style="display: none;">
        <h3 id="permisoFormTitle">Agregar Permiso</h3>
        <form id="permisoFormElement">
          <input type="hidden" id="permiso_id" />
          <label>Nombre del Permiso</label>
          <input id="permiso_nombre" required />
          <label>Descripción</label>
          <textarea id="permiso_descripcion" rows="3"></textarea>

          <div style="margin-top:10px;">
            <button id="savePermisoBtn" type="submit">Guardar</button>
            <button id="cancelPermisoBtn" type="button">Cancelar</button>
          </div>
          <div id="permisoResultMsg" style="margin-top:8px;"></div>
        </form>
      </section>
    </div>

    <!-- Sección de Asignación de Permisos a Roles -->
    <div id="roles-permisos-tab" class="tab-content">
      <section class="table-wrap">
        <h3>Asignación de Permisos por Rol</h3>
        <div style="margin-bottom: 10px;">
          <label>Seleccionar Rol:</label>
          <select id="rolSelect">
            <option value="">Seleccione un rol</option>
          </select>
        </div>
        
        <div id="permisosRolContainer" style="display: none;">
          <h4>Permisos del Rol: <span id="rolNombre"></span></h4>
          <div style="margin-bottom: 10px;">
            <button id="savePermisosRolBtn" class="btn-primary">Guardar Permisos</button>
          </div>
          <div id="permisosCheckboxes"></div>
        </div>
      </section>
    </div>

    <div id="output"></div>
  </main>

  <script src="/js/auth.js"></script>
  <script>
    (async function () {
      const auth = window.APP_AUTH;
      if (!auth.isAuthenticated()) { location.replace('/login.html'); return; }
      
      const user = auth.getUser();
      document.getElementById('userInfo').textContent = user ? `${user.nombre} (${(user.roles||[]).join(', ')})` : '';

      // Verificar si es administrador
      const roles = user?.roles || [];
      const isAdmin = roles.map(r => String(r).toLowerCase()).includes('admin');
      
      if (!isAdmin) {
        // Si no es admin, ocultar tabs de permisos
        document.querySelector('[data-tab="permisos"]').style.display = 'none';
        document.querySelector('[data-tab="roles-permisos"]').style.display = 'none';
      }

      // Elementos del DOM
      const tbody = document.querySelector('#usersTable tbody');
      const rolesSelect = document.getElementById('edit_tipo_usuario');
      const form = document.getElementById('editForm');
      const resultMsg = document.getElementById('resultMsg');
      
      // Elementos de permisos
      const permisosTable = document.querySelector('#permisosTable tbody');
      const permisoForm = document.getElementById('permisoForm');
      const permisoFormElement = document.getElementById('permisoFormElement');
      const rolSelect = document.getElementById('rolSelect');
      const permisosRolContainer = document.getElementById('permisosRolContainer');
      const permisosCheckboxes = document.getElementById('permisosCheckboxes');

      // Variables globales
      let todosLosPermisos = [];
      let todosLosRoles = [];

      // Funciones para manejar tabs
      function initTabs() {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        tabButtons.forEach(button => {
          button.addEventListener('click', () => {
            const tabName = button.dataset.tab;
            
            // Remover clase active de todos los botones y contenidos
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));
            
            // Agregar clase active al botón y contenido seleccionado
            button.classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');
          });
        });
      }

      // Funciones de permisos (solo para administradores)
      async function loadPermisos() {
        if (!isAdmin) return;
        
        try {
          const res = await auth.fetchAuth('/api/permisos');
          const json = await res.json();
          todosLosPermisos = json.permisos || [];
          
          permisosTable.innerHTML = todosLosPermisos.map(p => `
            <tr>
              <td>${p.id_permiso}</td>
              <td>${p.nombre_permiso}</td>
              <td>${p.descripcion || ''}</td>
              <td>
                <button data-id="${p.id_permiso}" class="btn-edit">Editar</button>
                <button data-id="${p.id_permiso}" class="btn-delete">Eliminar</button>
              </td>
            </tr>
          `).join('');

          // Attach events
          document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEditPermisoClick));
          document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDeletePermisoClick));

        } catch (err) {
          console.error('Error cargando permisos', err);
        }
      }

      async function loadPermisosByRol(id_rol) {
        if (!isAdmin) return;
        
        try {
          const res = await auth.fetchAuth(`/api/permisos/rol/${id_rol}`);
          const json = await res.json();
          const permisosDelRol = json.permisos || [];
          
          // Crear checkboxes para todos los permisos
          permisosCheckboxes.innerHTML = todosLosPermisos.map(permiso => {
            const tienePermiso = permisosDelRol.some(p => p.id_permiso === permiso.id_permiso);
            return `
              <label style="display: block; margin: 5px 0;">
                <input type="checkbox" value="${permiso.id_permiso}" ${tienePermiso ? 'checked' : ''}>
                <strong>${permiso.nombre_permiso}</strong> - ${permiso.descripcion || 'Sin descripción'}
              </label>
            `;
          }).join('');

        } catch (err) {
          console.error('Error cargando permisos del rol', err);
        }
      }

      async function loadRoles() {
        try {
          const res = await auth.fetchAuth('/api/roles');
          const json = await res.json();
          const roles = json.roles || [];
          rolesSelect.innerHTML = roles.map(r => `<option value="${r.id_rol}">${r.nombre_rol}</option>`).join('');
        } catch (err) {
          console.error('Error cargando roles', err);
        }
      }

      async function loadUsers() {
        try {
          const res = await auth.fetchAuth('/api/users');
          const json = await res.json();
          const users = json.users || [];
          tbody.innerHTML = users.map(u => `
            <tr>
              <td>${u.id_usuario}</td>
              <td>${u.nombre}</td>
              <td>${u.email}</td>
              <td>${u.tipo_usuario ?? ''}</td>
              <td>${u.activo ? 'Activo' : 'Inactivo'}</td>
              <td>
                <button data-id="${u.id_usuario}" class="btn-edit">Editar</button>
                <button data-id="${u.id_usuario}" class="btn-delete">Eliminar</button>
              </td>
            </tr>
          `).join('');

          // attach events
          document.querySelectorAll('.btn-edit').forEach(b => b.addEventListener('click', onEditClick));
          document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', onDeleteClick));

        } catch (err) {
          console.error('Error cargando usuarios', err);
        }
      }

      function clearForm() {
        form.reset();
        document.getElementById('edit_id').value = '';
        resultMsg.textContent = '';
      }

      async function onEditClick(e) {
        const id = e.currentTarget.dataset.id;
        // poblar formulario con datos del usuario seleccionado (simple: buscamos en la tabla ya cargada)
        const row = e.currentTarget.closest('tr');
        document.getElementById('edit_id').value = id;
        document.getElementById('edit_nombre').value = row.children[1].textContent;
        document.getElementById('edit_email').value = row.children[2].textContent;
        // tipo_usuario: en la tabla solo vemos id; set value
        document.getElementById('edit_tipo_usuario').value = row.children[3].textContent || '';
        document.getElementById('edit_activo').value = row.children[4].textContent === 'Activo' ? '1' : '0';
        document.getElementById('edit_password').value = '';
        window.scrollTo({ top: document.querySelector('.edit-panel').offsetTop, behavior: 'smooth' });
      }

      async function onDeleteClick(e) {
        if (!confirm('¿Seguro que deseas eliminar este usuario?')) return;
        const id = e.currentTarget.dataset.id;
        try {
          const res = await auth.fetchAuth(`/api/users/${id}`, { method: 'DELETE' });
          const body = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
          resultMsg.textContent = 'Usuario eliminado correctamente';
          await loadUsers();
        } catch (err) {
          resultMsg.textContent = `Error: ${err.message}`;
        }
      }

      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        const id = document.getElementById('edit_id').value;
        if (!id) { resultMsg.textContent = 'Seleccione un usuario a editar'; return; }
        const payload = {
          nombre: document.getElementById('edit_nombre').value,
          email: document.getElementById('edit_email').value,
          tipo_usuario: Number(document.getElementById('edit_tipo_usuario').value) || null,
          activo: document.getElementById('edit_activo').value === '1' ? 1 : 0
        };
        const password = document.getElementById('edit_password').value;
        if (password) payload.password = password;

        try {
          const res = await auth.fetchAuth(`/api/users/${id}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const body = await res.json().catch(()=>({}));
          if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
          resultMsg.textContent = 'Usuario actualizado correctamente';
          await loadUsers();
          // limpiar password
          document.getElementById('edit_password').value = '';
        } catch (err) {
          resultMsg.textContent = `Error: ${err.message}`;
        }
      });

      document.getElementById('cancelBtn').addEventListener('click', () => clearForm());
      document.getElementById('logoutBtn').addEventListener('click', () => { auth.logout(); location.replace('/login.html'); });

      // Event listeners para permisos (solo para administradores)
      if (isAdmin) {
        document.getElementById('addPermisoBtn').addEventListener('click', () => {
          document.getElementById('permisoFormTitle').textContent = 'Agregar Permiso';
          permisoFormElement.reset();
          document.getElementById('permiso_id').value = '';
          permisoForm.style.display = 'block';
        });

        document.getElementById('cancelPermisoBtn').addEventListener('click', () => {
          permisoForm.style.display = 'none';
        });

        rolSelect.addEventListener('change', (e) => {
          const id_rol = e.target.value;
          if (id_rol) {
            const rol = todosLosRoles.find(r => r.id_rol == id_rol);
            document.getElementById('rolNombre').textContent = rol.nombre_rol;
            permisosRolContainer.style.display = 'block';
            loadPermisosByRol(id_rol);
          } else {
            permisosRolContainer.style.display = 'none';
          }
        });

        document.getElementById('savePermisosRolBtn').addEventListener('click', async () => {
          const id_rol = rolSelect.value;
          if (!id_rol) return;

          const checkboxes = permisosCheckboxes.querySelectorAll('input[type="checkbox"]:checked');
          const permisos_ids = Array.from(checkboxes).map(cb => parseInt(cb.value));

          try {
            const res = await auth.fetchAuth(`/api/permisos/rol/${id_rol}/permisos`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ permisos_ids })
            });
            
            const body = await res.json();
            if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
            
            alert('Permisos guardados correctamente');
          } catch (err) {
            alert(`Error: ${err.message}`);
          }
        });

        permisoFormElement.addEventListener('submit', async (e) => {
          e.preventDefault();
          const id = document.getElementById('permiso_id').value;
          const payload = {
            nombre_permiso: document.getElementById('permiso_nombre').value,
            descripcion: document.getElementById('permiso_descripcion').value
          };

          try {
            let res;
            if (id) {
              // Actualizar
              res = await auth.fetchAuth(`/api/permisos/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            } else {
              // Crear
              res = await auth.fetchAuth('/api/permisos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
            }
            
            const body = await res.json();
            if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
            
            document.getElementById('permisoResultMsg').textContent = 'Permiso guardado correctamente';
            permisoForm.style.display = 'none';
            await loadPermisos();
          } catch (err) {
            document.getElementById('permisoResultMsg').textContent = `Error: ${err.message}`;
          }
        });

        function onEditPermisoClick(e) {
          const id = e.currentTarget.dataset.id;
          const permiso = todosLosPermisos.find(p => p.id_permiso == id);
          
          document.getElementById('permisoFormTitle').textContent = 'Editar Permiso';
          document.getElementById('permiso_id').value = id;
          document.getElementById('permiso_nombre').value = permiso.nombre_permiso;
          document.getElementById('permiso_descripcion').value = permiso.descripcion || '';
          permisoForm.style.display = 'block';
        }

        async function onDeletePermisoClick(e) {
          if (!confirm('¿Seguro que deseas eliminar este permiso?')) return;
          const id = e.currentTarget.dataset.id;
          
          try {
            const res = await auth.fetchAuth(`/api/permisos/${id}`, { method: 'DELETE' });
            const body = await res.json();
            if (!res.ok) throw new Error(body.message || `HTTP ${res.status}`);
            
            await loadPermisos();
          } catch (err) {
            alert(`Error: ${err.message}`);
          }
        }
      }

      // Inicialización
      initTabs();
      await loadRoles();
      await loadUsers();
      if (isAdmin) {
        await loadPermisos();
      }
    })();
  </script>
</body>
</html>
